# Auto-Update System Guide

**Version:** 1.0  
**Last Updated:** November 6, 2025  
**Status:** ‚úÖ Implemented

---

## üìã Overview

Stories includes an automatic update system powered by `electron-updater`. Users are notified when new versions are available and can update with a single click.

---

## üéØ User Experience

### **How it Works for Users:**

1. **Automatic Check:** Stories checks for updates 3 seconds after launch (non-blocking)
2. **Notification:** If an update is available, a beautiful notification appears in the top-right
3. **User Choice:**
   - **"Update Now"** ‚Üí Downloads and prepares the update
   - **"Later"** ‚Üí Dismisses the notification (will check again on next launch)
4. **Download:** Progress bar shows download status
5. **Install:** After download, user clicks "Restart to Update"
6. **Restart:** App closes, installs update, and reopens with new version ‚ú®

### **Visual Flow:**

```
[App Launches]
    ‚Üì
[Checks for updates after 3s]
    ‚Üì
[New version available?]
    ‚îú‚îÄ NO ‚Üí Continue normally
    ‚îî‚îÄ YES ‚Üí Show notification
           ‚Üì
    [User clicks "Update Now"]
           ‚Üì
    [Download with progress bar]
           ‚Üì
    [Show "Restart to Update" button]
           ‚Üì
    [User clicks ‚Üí App restarts with new version] ‚úÖ
```

---

## üèóÔ∏è Architecture

### **Components:**

#### **1. Main Process (`electron/main.js`)**
- Configures `autoUpdater` from `electron-updater`
- Handles update lifecycle events
- Sends events to renderer via IPC

```javascript
// Key events:
- checking-for-update
- update-available
- update-downloaded
- download-progress
- error
```

#### **2. Preload (`electron/preload.js`)**
- Exposes secure IPC channels to renderer
- Both `electronAPI` and `api` interfaces available

#### **3. UpdateManager (`frontend/components/UpdateManager.js`)**
- Manages UI state and user interactions
- Handles download/install flow
- Shows notifications and progress

#### **4. UI (` index.html` + `components.css`)**
- Beautiful notification in top-right corner
- Progress bar for download status
- Responsive buttons

---

## üîß Implementation Details

### **Main Process Configuration**

```javascript
// Auto-updater settings
autoUpdater.autoDownload = false;      // Ask user first
autoUpdater.autoInstallOnAppQuit = true; // Install on quit

// Check for updates on startup
function checkForUpdatesOnStartup() {
  setTimeout(() => {
    autoUpdater.checkForUpdates();
  }, 3000); // 3 seconds delay
}
```

### **IPC Handlers**

```javascript
// Renderer ‚Üí Main
ipcMain.handle('check-for-updates')    // Manual check
ipcMain.handle('download-update')       // Start download
ipcMain.handle('install-update')        // Quit & install
ipcMain.handle('get-update-info')       // Get current version

// Main ‚Üí Renderer (events)
mainWindow.webContents.send('update-available', info)
mainWindow.webContents.send('update-downloaded', info)
mainWindow.webContents.send('update-download-progress', progress)
mainWindow.webContents.send('update-error', error)
```

### **UpdateManager API**

```javascript
class UpdateManager {
  // Public methods
  checkForUpdates()           // Manual check
  downloadUpdate()            // Start download
  installUpdate()             // Restart & install
  
  // Private handlers
  handleUpdateAvailable(info)
  handleUpdateDownloaded(info)
  handleDownloadProgress(progress)
  handleUpdateError(error)
  
  // UI methods
  showNotification(info)
  hideNotification()
  updateProgressBar(percent)
  showRestartButton()
}
```

---

## üì¶ Publishing Releases

### **Step 1: Build & Package**

```bash
# Increment version (choose one)
npm run version:patch  # 0.9.7 ‚Üí 0.9.8
npm run version:minor  # 0.9.7 ‚Üí 0.10.0
npm run version:major  # 0.9.7 ‚Üí 1.0.0

# Build notarized release
npm run release  # = npm run make + npm run notarize
```

This creates:
- `out/make/Stories.dmg` - Signed & notarized DMG
- `out/make/zip/darwin/arm64/Stories-darwin-arm64-{version}.zip` - ZIP for auto-update

### **Step 2: Create GitHub Release**

```bash
# On GitHub:
1. Go to: https://github.com/pixelspace-studio/stories-app/releases/new
2. Tag: v{version} (e.g., v1.0.0)
3. Title: "Stories v{version}"
4. Description: Release notes (changelog)
5. Upload files:
   - Stories.dmg (for manual download)
   - Stories-darwin-arm64-{version}.zip (for auto-update)
   - latest-mac.yml (auto-generated by electron-updater)
6. Publish release ‚úÖ
```

### **Step 3: Automatic Detection**

electron-updater automatically:
1. Checks GitHub releases for latest version
2. Compares with current app version
3. Downloads `latest-mac.yml` to get update info
4. Downloads ZIP file if update available

---

## üß™ Testing

### **Development Testing:**

#### **Test 1: Mock Update Available**

```javascript
// In electron/main.js, temporarily add:
autoUpdater.on('checking-for-update', () => {
  // Simulate update available for testing
  if (process.env.MOCK_UPDATE === 'true') {
    setTimeout(() => {
      mainWindow.webContents.send('update-available', {
        version: '99.99.99',
        releaseNotes: 'Test update for development',
        releaseDate: new Date().toISOString()
      });
    }, 2000);
  }
});

// Run with:
MOCK_UPDATE=true npm start
```

#### **Test 2: Real Update Flow**

```bash
# 1. Build version 0.9.7
npm run version:set 0.9.7
npm run make

# 2. Install and run v0.9.7

# 3. Publish v0.9.8 to GitHub

# 4. Launch v0.9.7 ‚Üí Should detect v0.9.8 available
```

### **Production Testing:**

1. **Fresh Install:** Install released version
2. **Launch:** App should check for updates
3. **Update Available:** If newer version exists, notification shows
4. **Download:** Click "Update Now" ‚Üí Progress bar appears
5. **Install:** Click "Restart to Update" ‚Üí App closes
6. **Verify:** App reopens with new version

**Check version:**
- Menu Bar Icon ‚Üí About Stories
- Or check `package.json` version

---

## üîê Security

### **Verification:**

electron-updater automatically verifies:
- ‚úÖ **Code signature** - DMG/ZIP must be signed
- ‚úÖ **Checksums** - SHA512 hash validation
- ‚úÖ **HTTPS** - All downloads over secure connection
- ‚úÖ **Same publisher** - Certificate must match

### **Safe Channels:**

```javascript
// preload.js whitelist
const allowedChannels = [
  'check-for-updates',
  'download-update',
  'install-update',
  'get-update-info'
];
// ‚Üë Only these IPC channels are exposed
```

---

## ‚öôÔ∏è Configuration

### **Update Frequency:**

```javascript
// electron/main.js
function checkForUpdatesOnStartup() {
  setTimeout(() => {
    autoUpdater.checkForUpdates();
  }, 3000); // ‚Üê Change delay (milliseconds)
}
```

**Default:** Check once on startup (3s delay)  
**Future:** Could add periodic checks (e.g., every 24h)

### **Auto-Download:**

```javascript
// electron/main.js
autoUpdater.autoDownload = false; // ‚Üê User must confirm
```

**Current:** Asks user permission  
**Alternative:** Set to `true` for silent downloads

### **GitHub Repository:**

```json
// package.json
{
  "publish": {
    "provider": "github",
    "owner": "Floristeady",
    "repo": "stories-app"
  }
}
```

---

## üìù Release Checklist

Before publishing a new version:

- [ ] Update `CHANGELOG.md` with release notes
- [ ] Run version script: `npm run version:patch` (or minor/major)
- [ ] Build release: `npm run release`
- [ ] Test notarization: `npm run notarize:check`
- [ ] Create GitHub release with tag `v{version}`
- [ ] Upload `Stories.dmg` and `.zip` to release
- [ ] Write clear release notes
- [ ] Publish release
- [ ] Test auto-update on older version

---

## üêõ Troubleshooting

### **Issue: Update notification doesn't appear**

**Possible causes:**
1. No internet connection
2. GitHub API rate limit
3. Release not published yet
4. Already on latest version

**Debug:**
```bash
# Check logs
tail -f ~/Library/Logs/Stories/main.log | grep -i update

# Look for:
[AutoUpdater] Checking for update...
[AutoUpdater] Update available: {version}
[AutoUpdater] Update not available
[AutoUpdater] Error: {error}
```

### **Issue: Download fails**

**Check:**
- Network connection
- GitHub release has `.zip` file
- File is not corrupted
- Sufficient disk space

**Re-try:**
- Click "Update Now" again
- Or manually download from GitHub releases

### **Issue: Won't install after download**

**Verify:**
- Update actually downloaded (check `~/Library/Application Support/Stories`)
- Click "Restart to Update" button
- App has write permissions to `/Applications`

---

## üìö References

- [electron-updater Documentation](https://www.electron.build/auto-update)
- [Electron Forge](https://www.electronforge.io/)
- [GitHub Releases API](https://docs.github.com/en/rest/releases)

---

## üéâ Summary

**Auto-update is now live!** üöÄ

**For Developers:**
- Build ‚Üí Notarize ‚Üí Publish to GitHub
- electron-updater handles the rest automatically

**For Users:**
- Seamless one-click updates
- No need to download manually
- Always on the latest version

**Next Steps:**
1. Test with real releases
2. Monitor update adoption in telemetry
3. Consider adding update settings (e.g., disable auto-check)
4. Add update channel support (stable/beta)

---

**Questions?** See `RELEASE_GUIDE.md` for complete release process.

